## 1. 문서 정보

**문서명**: 방문자 체크인 시스템 기능 명세서

**작성일**: 2026-01-28

**수정일**: 2026-02-04

---

## 2. 기능 개요

본 시스템은 5개의 주요 모듈로 구성되며, 각 모듈은 독립적으로 작동하면서 통합되어 완전 자동 방문자 기록 시스템을 제공합니다.

> **시스템 아키텍처**: 전체 시스템 구조 및 데이터 흐름은 [ARCHITECTURE.md](./ARCHITECTURE.md)를 참조하세요.

---

## 3. 모듈별 상세 기능

### 모듈 1: 웹 사용자 인터페이스 (React)

### 1.1 공통 헤더/네비게이션

- 서비스명 및 로고 표시
- 한/영 지원 토글 버튼

### 1.2 카메라 체크인 화면 (AI 모드)

**기능**:
- 웹캠을 통한 실시간 얼굴 인식 (face-api.js)
- AI 스캔 버튼으로 성별/연령대 자동 감지
- 스캔 확인 모달:
  - "확인": Firestore에 즉시 전송
  - "수정": 방문자 리스트로 추가 (수동 편집 가능)
  - "닫기": 스캔 결과 취소
- 프라이버시: "이미지는 저장되지 않습니다" 안내
- 성공 시 자동 팝업 (3초), 오류 시 재시도 안내

### 1.3 수동 입력 화면

**기능**:
- 성별 토글 버튼 (남성/여성)
- 연령대 그리드 버튼 (유아/어린이/청소년/청년/중년/노년)
- "추가" 버튼으로 방문자 리스트에 추가
- AI 스캔 결과 수정용으로도 사용
- "모드 전환" 버튼으로 AI 모드 복귀

### 1.4 관리자 잠금 화면

**기능**:
- 관람실 선택 (기본 목록만, 커스텀은 대시보드에서)
- PIN 비밀번호 인증
- localStorage에 설정 저장
- HTTPS 전송, 클라이언트 사이드 검증

### 1.5 방문자 리스트

**기능**:
- 동일 성별/연령대/입력방식 자동 그룹화 (예: 청년 남성 x3)
- +/- 버튼으로 수량 조절, X 버튼으로 그룹 삭제
- "초기화" 버튼으로 전체 목록 비우기
- 총 인원수 배지 표시
- "완료" 버튼으로 Firestore 전송

**데이터 관리**:
- localStorage에 일일 통계용 데이터 유지
- Firestore 전송 성공 시 리스트만 초기화
- 과거 날짜 데이터는 앱 시작 시 자동 삭제

---

### 1.6 관리자 대시보드

**목적**: 관리자가 일일 통계와 설정을 관리

**접근 방법**: 로고를 3회 연속 터치 (3초 내)

**기능**:

- **일일 통계 표시** (localStorage 기반, 관람실별 필터링)
    - 오늘의 누적 입장객 수 (현재 관람실)
    - 연령대별 분포 (막대 차트)
    - 성별 분포 (도넛 차트 + 비율 표시)
    - 자정마다 자동 초기화
- **설정 관리**
    - 관람실 선택 (드롭다운)
        - 기본 관람실 목록에서 선택
        - "직접 입력 (커스텀)" 옵션 선택 시 커스텀 관람실 이름 입력 가능
        - 커스텀 관람실 입력 필드: 텍스트 입력, Edit3 아이콘 표시
        - 입력된 커스텀 관람실 이름은 데이터 전송에 사용됨
    - 나이 보정값 조정 (-10 ~ +10, 슬라이더)
    - 설정 저장 (localStorage)
- **수동 백업 및 삭제**
    - Firestore 데이터를 Google Sheets로 즉시 백업 후 자동 삭제
    - 2단계 확인 모달, 자동 재시도, 진행 상태 표시
    - Google Apps Script 연동 (1-3분 소요)
- **데이터 소스 안내**
    - "기기 임시 저장 데이터입니다"
    - "정확한 전체 데이터는 Firebase 또는 엑셀을 확인하세요"

**데이터 소스**: localStorage만 사용 (Firestore 조회 없음)
- 오늘 날짜의 방문객 데이터만 조회
- 선택한 관람실의 방문객만 필터링
- 앱 시작 시 과거 날짜 데이터 자동 삭제

**접근 제어**: 별도 인증 없음 (로고 3회 터치만)

---

### 모듈 2: 얼굴 인식 엔진 (face-api.js)

**모델 로드**: 성별/연령/얼굴 감지 모델 (public/models/ 폴더), 초기화 2~3초

**얼굴 감지**: 30fps 실시간 감지, 신뢰도 50% 이상, 얼굴 위치 박스 표시

**성별 및 연령대 예측**:
- 성별 분류: 남성/여성 (확률 기반)
- 연령대 변환: AI 인식 나이 + 보정값(기본 +4세)
  - 0~6세: 유아, 7~12세: 어린이, 13~19세: 청소년
  - 20~39세: 청년, 40~64세: 중년, 65세+: 노년
- 나이 보정값: -10 ~ +10 범위 (관리자 대시보드에서 조정)
- 정확도: 성별 80~85%, 연령대 70~75%

---

### 모듈 3: 데이터 저장소 (Firebase Firestore)

### 3.1 Collection 구조

```
visitors/
├── document ID: timestamp (자동 생성)
├── timestamp: "2026-01-28T14:30:45Z"
├── gender: "남성" | "여성"
├── ageGroup: "10대" | "20대" | ... | "60대+"
├── source: "AI" | "수동"
├── location: "상설전시" | "다목적실-1" | ...

```

### 3.2 데이터 쓰기

**목적**: 체크인 데이터 저장

**트리거**: 사용자가 "체크인" 버튼 클릭

**처리**:

```jsx
{
  timestamp: new Date().toISOString(),
  gender: detectedGender,
  ageGroup: convertedAgeGroup,
  source: "AI" || "수동",
  location: selectedLocation
}

```

**응답 시간**: 1초 이내

**오류 처리**: 네트워크 오류 시 재시도 버튼 제공 (ErrorModal)

### 3.3 권한 관리

**Firestore Security Rules**:

```
- 읽기: 인증된 사용자만
- 쓰기: 인증된 사용자만
- 삭제: Apps Script 서비스 계정만

```

---

### 모듈 4: 자동화 엔진 (Google Apps Script)

### 4.1 자동 백업 함수 (backupAndDelete)

**목적**: Firestore 데이터를 Google Sheets에 정기적으로 백업

**실행 조건**:

- 트리거: 사용자 설정 간격 (1/3/6/12시간)
- 실행 시간 제한: 6분 이내
- 타임아웃 시: 작업 중단 후 오류 알림 (로그/이메일)

**처리 흐름**:

1. **데이터 조회** (fetchAllDocuments)
    - Firestore에서 모든 문서 조회
    - pageSize: 300 (페이지네이션)
    - 페이지네이션: 자동으로 모든 페이지 조회
    - 경고: 실행 시간 체크 (4.5분 초과 시 중단)
2. **데이터 검증**
    - 빈 데이터셋 확인
    - 필수 필드 검증 (timestamp, gender, ageGroup 등)
3. **Google Sheets에 추가**
    - 배열로 한 번에 처리 (setValues API)
    - KST 시간대로 날짜 포맷팅
    - 컬럼 순서: [날짜시간, 성별, 연령대, 방법, 장소]
4. **안전한 삭제**
    - 백업 성공 확인 후에만 삭제 진행
    - Batch Delete API 사용 (500개/배치)
    - 개별 삭제 대비 10배 이상 빠름
5. **로깅 및 알림**
    - 성공: "✓ 총 X개 문서 조회 및 백업 완료"
    - 오류: 이메일 알림 (ALERT_EMAIL로)

### 4.2 Apps Script 설치 및 설정

**파일 위치**: `./public/script.txt`

**설치 가이드**:
- 상세한 설치 및 설정 방법은 `public/script.txt` 파일의 주석을 참조하세요
- 주요 설정 항목:
  - Firebase 서비스 계정 정보 (CLIENT_EMAIL, PRIVATE_KEY, PROJECT_ID)
  - Firestore 컬렉션명 (COLLECTION_NAME)
  - Google Sheets 탭 이름 (SHEET_NAME)
  - 오류 알림 이메일 (ALERT_EMAIL)
- OAuth2 라이브러리 추가 필수
- 트리거 설정: 1/3/6/12시간 간격 선택

### 4.3 설정 검증 함수 (validateConfig)

**목적**: 필수 설정값 확인

**검증 항목**: CLIENT_EMAIL, PRIVATE_KEY, PROJECT_ID, COLLECTION_NAME, SHEET_NAME, ALERT_EMAIL

**동작**: 누락 항목 발견 시 명확한 오류 메시지 출력

### 4.4 Firebase 인증 (getFirebaseService)

**목적**: OAuth2로 Firebase API 접근

**동작**: 서비스 계정 키로 토큰 생성 (1시간 유효, 자동 캐싱 및 갱신)

### 4.5 삭제 함수 (deleteDocuments)

**특징**:
- Batch Delete API 활용 (500개/배치)
- 개별 삭제 대비 10배 이상 빠름
- 성능: 1,500개 문서 삭제 시 약 30초 소요

### 4.6 트리거 설정

**옵션**: 1/3/6/12시간 간격 선택 (트래픽에 따라 조정)

**설정 위치**: Apps Script 대시보드 → 트리거 메뉴

---

### 모듈 5: 영구 저장소 (Google Sheets)

### 5.1 시트 구조

**시트명**: 시트1 (기본값, 설정 가능)

**컬럼 헤더** (자동 생성):

| A | B | C | D | E |
| --- | --- | --- | --- | --- |
| 날짜시간 | 성별 | 연령대 | 방법 | 장소 |

**데이터 행**:

```
2026-01-28 14:30:45 | 남성 | 30대 | AI | 다목적실-1
2026-01-28 14:35:12 | 여성 | 20대 | 수동 | 상설전시

```

### 5.2 데이터 추가

**동작**: 설정된 시각마다 새 행 추가 (setValues() API 활용)

**성능**: 100행 <1초, 300행 <2초, 1,500행 <5초

### 5.3 통계 활용

**지원 함수**: COUNTA, COUNTIF, AVERAGE 등 Google Sheets 기본 함수 활용

### 5.4 용량 관리

**저장량**: 1,000만 셀
**예상 사용량**: 연간 365만 셀 (36% 사용)
**유지보수**: 연 1회 이전 연도 데이터 별도 파일로 이동 또는 월별 시트 분할

---

> **참고**: 데이터 흐름 및 오류 처리에 대한 상세 내용은 [ARCHITECTURE.md](./ARCHITECTURE.md) 및 [MAINTENANCE_GUIDE.md](./MAINTENANCE_GUIDE.md)를 참조하세요.